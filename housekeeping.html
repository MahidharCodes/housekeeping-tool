<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Housekeeping Assignment Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background-color: #2c3e50;
      color: white;
      width: 100%;
      padding: 20px;
      text-align: center;
      font-size: 24px;
    }
    .container {
      margin-top: 30px;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    label {
      font-weight: 600;
      margin: 10px 0 5px;
      display: block;
    }
    input[type="file"], select, input[type="date"] {
      padding: 8px 10px;
      width: 100%;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #output {
      display: flex;
      justify-content: space-around;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #2980b9;
    }
    .section {
      margin-top: 30px;
      width: 90%;
      max-width: 700px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #ecf0f1;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .print-btn {
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <header>
    üè® Housekeeping Assignment Tool
  </header>
  <div class="container">
    <label>Upload PDF:</label>
    <input type="file" id="pdf-upload" accept="application/pdf">
    <label>Absent Staff:</label>
    <select id="absent-select">
      <option value="none">None</option>
      <option value="person1">Rosa Absent</option>
      <option value="person2">Ruby Absent</option>
    </select>
    <button onclick="generateAssignments()">Generate Assignments</button>
  </div>
  
  <div class="print-btn" id="print-btn" style="display: none;">
    <button onclick="printAllPDFs()">üñ∂Ô∏è Print All</button>
  </div>
  
  <div id="output"></div>

  <script>
    const nameMap = {
      person1: "Rosa",
      person2: "Ruby",
      person3: "Maria"
    };

    async function extractTextFromPDF(file) {
      const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += textContent.items.map(item => item.str).join('\n');
      }
      return fullText;
    }

    function parseRoomData(text) {
      const lines = text.split(/\n+/);
      const data = [];
      for (let i = 0; i < lines.length - 4; i++) {
        const room = lines[i];
        const status = lines[i + 2];
        const stay = lines[i + 4];
        if (/^\d{3}$/.test(room) && status === "Occupied and Dirty" && (stay === "Occupied" || stay === "Pending Depart")) {
          data.push({ room: parseInt(room), status, stay });
          i += 4;
        }
      }
      return data.sort((a, b) => a.room - b.room);
    }

    function splitAssignments(rooms, absent) {
      const firstFloor = rooms.filter(r => r.room >= 100 && r.room < 200);
      const secondFloor = rooms.filter(r => r.room >= 200 && r.room < 300);
      const total = rooms.length;
      const q1 = Math.ceil(total / 4);
      const q2 = Math.ceil(total / 4);
      const q3 = total - q1 - q2;

      let person1 = [], person2 = [], person3 = [];

      if (absent === 'person1') {
        const p2Count = Math.ceil(total / 3);
        person2 = secondFloor.slice(0, p2Count);
        const used = new Set([...person2.map(r => r.room)]);
        person3 = rooms.filter(r => !used.has(r.room));
        return [[nameMap.person2, person2], [nameMap.person3, person3]];
      } else if (absent === 'person2') {
        const p1Count = Math.ceil(total / 3);
        person1 = firstFloor.slice(0, p1Count);
        const used = new Set([...person1.map(r => r.room)]);
        person3 = rooms.filter(r => !used.has(r.room));
        return [[nameMap.person1, person1], [nameMap.person3, person3]];
      } else {
        person1 = firstFloor.slice(0, q1);
        person2 = secondFloor.slice(0, q2);
        const used = new Set([...person1, ...person2].map(r => r.room));
        person3 = rooms.filter(r => !used.has(r.room));
        return [[nameMap.person1, person1], [nameMap.person2, person2], [nameMap.person3, person3]];
      }
    }

    let cachedAssignments = [];

    function generateAssignments() {
      const fileInput = document.getElementById('pdf-upload');
      const absent = document.getElementById('absent-select').value;
      if (!fileInput.files[0]) return alert('Please upload a PDF first.');

      extractTextFromPDF(fileInput.files[0]).then(text => {
        const parsedRooms = parseRoomData(text);
        const assignments = splitAssignments(parsedRooms, absent);
        cachedAssignments = assignments;

        const container = document.getElementById("output");
        container.innerHTML = "";

        assignments.forEach(([person, list]) => {
          const section = document.createElement("div");
          section.className = "section";
          const title = document.createElement("h3");
          title.innerText = `${person}'s Assignment List`;
          const table = document.createElement("table");
          table.innerHTML = '<tr><th>S.No</th><th>Room</th><th>C/O</th><th>S/O</th><th>Notes</th></tr>';
          list.forEach((r, i) => {
            const co = r.stay === 'Pending Depart' ? 'C' : '';
            const so = r.stay === 'Occupied' ? 'S' : '';
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${i + 1}</td><td>${r.room}</td><td>${co}</td><td>${so}</td><td></td>`;
            table.appendChild(tr);
          });
          const btn = document.createElement("button");
          btn.innerText = `Download ${person}'s PDF`;
          btn.onclick = () => generateSplitTablePDF(person, list).save(`${person}_Assignment.pdf`);
          section.appendChild(btn);
          section.appendChild(title);
          section.appendChild(table);
          container.appendChild(section);
        });
      });
      document.getElementById("print-btn").style.display = "block";
    }

    function generateSplitTablePDF(assignee, rooms, doc) {
      const { jsPDF } = window.jspdf;
      doc = doc || new jsPDF({ orientation: 'landscape' });
      const now = new Date();
      const dateStr = now.toLocaleDateString();
      const dayStr = now.toLocaleDateString(undefined, { weekday: 'long' });

      let serialOffset = 1;
      const chunkSize = 36;

      for (let i = 0; i < rooms.length; i += chunkSize) {
        if (i > 0) doc.addPage();

        const pageRooms = rooms.slice(i, i + chunkSize);
        const left = pageRooms.slice(0, 18);
        const right = pageRooms.slice(18);

        const mapRows = (data, offset) => data.map((r, idx) => [
          offset + idx,
          r.room,
          r.stay === 'Pending Depart' ? 'C' : '',
          r.stay === 'Occupied' ? 'S' : '',
          ''
        ]);

        doc.setFontSize(22);
        doc.text(`Housekeeper: ${assignee}`, 14, 15);
        doc.text(`Date: ${dateStr}`, 155, 15);
        doc.text(`Day: ${dayStr}`, 232, 15);

        doc.autoTable({
          head: [["#", "Room", "C/O", "S/O", "Notes"]],
          body: mapRows(left, serialOffset),
          startY: 25,
          margin: { left: 14 },
          theme: 'grid',
          styles: { fontSize: 12, cellPadding: 2, halign: 'center', textColor: [0, 0, 0], lineWidth: 0.1, lineColor: [0, 0, 0] },
          headStyles: { fillColor: [255, 255, 255], halign: 'center', textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.1, lineColor: [0, 0, 0] },
          columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 17 }, 2: { cellWidth: 12 }, 3: { cellWidth: 12 }, 4: { cellWidth: 80 } }
        });

        doc.autoTable({
          head: [["#", "Room", "C/O", "S/O", "Notes"]],
          body: mapRows(right, serialOffset + left.length),
          startY: 25,
          margin: { left: 155 },
          theme: 'grid',
          styles: { fontSize: 12, cellPadding: 2, halign: 'center', textColor: [0, 0, 0], lineWidth: 0.1, lineColor: [0, 0, 0] },
          headStyles: { fillColor: [255, 255, 255], halign: 'center', textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.1, lineColor: [0, 0, 0] },
          columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 17 }, 2: { cellWidth: 12 }, 3: { cellWidth: 12 }, 4: { cellWidth: 80 } }
        });

        serialOffset += pageRooms.length;
      }

      return doc;
    }

    function printAllPDFs() {
      const { jsPDF } = window.jspdf;
      const merged = new jsPDF({ orientation: 'landscape' });
      cachedAssignments.forEach(([person, list], idx) => {
        const tempDoc = generateSplitTablePDF(person, list);
        if (idx !== 0) merged.addPage();
        const pages = tempDoc.internal.getNumberOfPages();
        for (let i = 1; i <= pages; i++) {
          if (i > 1) merged.addPage();
          merged.setPage(merged.internal.getNumberOfPages());
          const tempPage = tempDoc.internal.pages[i];
          merged.internal.pages[merged.internal.getNumberOfPages()] = tempPage;
        }
      });
      merged.output('dataurlnewwindow');
    }
  </script>
</body>
</html>
